# ğŸ  LH ê³µì‚¬ ì„ëŒ€/ë¶„ì–‘ ê³µê³  RAG íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì²˜

> **Multi-Query + Hybrid Search + CrossEncoder Rerank ê¸°ë°˜ RAG ì‹œìŠ¤í…œ**

---

## ğŸ“‹ ëª©ì°¨

1. [ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”](#1-ì „ì²´-ì•„í‚¤í…ì²˜-ê°œìš”)
2. [Stage 0: Multi-Query ìƒì„±](#2-stage-0-multi-query-ìƒì„±)
3. [Stage 1: Hybrid Retrieval](#3-stage-1-hybrid-retrieval-í•˜ì´ë¸Œë¦¬ë“œ-ê²€ìƒ‰)
4. [Stage 2: Reranking](#4-stage-2-reranking-ì¬ì •ë ¬)
5. [Stage 3: Prompt Engineering](#5-stage-3-prompt-engineering)
6. [Stage 4: Generation](#6-stage-4-generation-ë‹µë³€-ìƒì„±)
7. [Stage 5: Response Formatting](#7-stage-5-response-formatting)
8. [ê¸°ìˆ  ìŠ¤íƒ ìš”ì•½](#8-ê¸°ìˆ -ìŠ¤íƒ-ìš”ì•½)
9. [ì½”ë“œ êµ¬ì¡°](#9-ì½”ë“œ-êµ¬ì¡°)
10. [ë°ì´í„° íë¦„](#10-ë°ì´í„°-íë¦„)

---

## 1. ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”

### 1.1 ì‹œìŠ¤í…œ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥                                      â”‚
â”‚                    "LH í–‰ë³µì£¼íƒ ì²­ë…„ ì¡°ê±´ì´ ë­ì•¼?"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Stage 0: Multi-Query ìƒì„± (LLM)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  [ì›ë³¸]  LH í–‰ë³µì£¼íƒ ì²­ë…„ ì¡°ê±´ì´ ë­ì•¼?                                     â”‚    â”‚
â”‚  â”‚  [ë³€í™˜1] í–‰ë³µì£¼íƒ ì…ì£¼ ìê²© ìš”ê±´                                          â”‚    â”‚
â”‚  â”‚  [ë³€í™˜2] ì²­ë…„ ëŒ€ìƒ LH ì„ëŒ€ì£¼íƒ ì‹ ì²­ ì¡°ê±´ ë° ìê²© ê¸°ì¤€                        â”‚    â”‚
â”‚  â”‚  [ë³€í™˜3] LH ê³µê³µì„ëŒ€ ì²­ë…„ ì£¼íƒ ì§€ì› ëŒ€ìƒ                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼ (4ê°œ ì§ˆì˜ë¡œ ê°ê° ê²€ìƒ‰)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Stage 1: Hybrid Retrieval (ê²€ìƒ‰)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Dense Retriever       â”‚          â”‚   Sparse Retriever      â”‚               â”‚
â”‚  â”‚   (PGVector + OpenAI)   â”‚          â”‚   (BM25Okapi)           â”‚               â”‚
â”‚  â”‚   - Cosine Similarity   â”‚          â”‚   - í‚¤ì›Œë“œ ë§¤ì¹­          â”‚               â”‚
â”‚  â”‚   - top_k=5 per query   â”‚          â”‚   - top_k=5 per query   â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚              â”‚                                    â”‚                              â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                             â–¼                                                    â”‚
â”‚              ê²°í•© (ìµœëŒ€ 40ê°œ) â†’ ì¤‘ë³µ ì œê±° (ì•½ 15~25ê°œ)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Stage 2: Reranking (ì¬ì •ë ¬)                                â”‚
â”‚                    CrossEncoder (ms-marco-MiniLM-L-6-v2)                         â”‚
â”‚                         ìƒìœ„ 5ê°œ ë¬¸ì„œ ì„ íƒ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Stage 3: Prompt Engineering                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸        â”‚    +     â”‚   ì§ˆë¬¸ ìœ í˜• ë¶„ì„         â”‚               â”‚
â”‚  â”‚   (ì—­í• /ì›ì¹™/í˜•ì‹)       â”‚          â”‚   (ë™ì  ì§€ì‹œì‚¬í•­)        â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                             â”‚                                                    â”‚
â”‚                             â–¼                                                    â”‚
â”‚                    ì»¨í…ìŠ¤íŠ¸ í¬ë§·íŒ… (ë¬¸ì„œ + ë©”íƒ€ë°ì´í„°)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Stage 4: Generation (ìƒì„±)                                 â”‚
â”‚                    LLM (GPT-4o-mini, temperature=0.2)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Stage 5: Response Formatting                                  â”‚
â”‚                (Pydantic êµ¬ì¡°í™” + ì¶œì²˜ ì •ë³´ + ì‹ ë¢°ë„)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 í•µì‹¬ íŠ¹ì§•

| íŠ¹ì§• | ì„¤ëª… |
|------|------|
| **Multi-Query** | ì›ë³¸ ì§ˆë¬¸ì„ ì—¬ëŸ¬ í‘œí˜„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ê²€ìƒ‰ ë²”ìœ„ í™•ì¥ |
| **Hybrid Search** | Dense(ì˜ë¯¸ ê²€ìƒ‰) + Sparse(í‚¤ì›Œë“œ ê²€ìƒ‰) ê²°í•© |
| **CrossEncoder Rerank** | ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì •ë°€í•˜ê²Œ ì¬ì •ë ¬ |
| **ë™ì  í”„ë¡¬í”„íŠ¸** | ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¼ ì§€ì‹œì‚¬í•­ ìë™ ì¶”ê°€ |
| **ë¹„ë™ê¸° ì²˜ë¦¬** | `asyncpg`ë¥¼ í™œìš©í•œ DB ë¹„ë™ê¸° ì—°ê²° |

---

## 2. Stage 0: Multi-Query ìƒì„±

### 2.1 ê°œë…

ì‚¬ìš©ìì˜ **ì›ë³¸ ì§ˆë¬¸ 1ê°œ**ë¥¼ LLMì„ ì‚¬ìš©í•´ **ì—¬ëŸ¬ ê°œì˜ ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ë³€í™˜**í•˜ì—¬ ê²€ìƒ‰ ë²”ìœ„ë¥¼ ë„“íˆëŠ” ê¸°ë²•ì…ë‹ˆë‹¤.

### 2.2 ì‚¬ìš© ê¸°ìˆ 

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | `langchain_openai`, `langchain_core` |
| **í´ë˜ìŠ¤** | `ChatOpenAI`, `ChatPromptTemplate`, `StrOutputParser` |
| **ëª¨ë¸** | GPT-4o-mini |
| **Temperature** | 0.7 (ë‹¤ì–‘í•œ í‘œí˜„ ìƒì„±ì„ ìœ„í•´ ë†’ê²Œ ì„¤ì •) |

### 2.3 í”„ë¡¬í”„íŠ¸ ì„¤ê³„

```python
MULTI_QUERY_PROMPT = """ë‹¹ì‹ ì€ LH ê³µì‚¬ ì„ëŒ€/ë¶„ì–‘ ê³µê³  ê²€ìƒ‰ì„ ë•ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ì¬ì‘ì„±í•˜ì—¬ ê²€ìƒ‰ ì„±ëŠ¥ì„ ë†’ì´ì„¸ìš”.

ì›ë³¸ ì§ˆë¬¸ì— ëŒ€í•´ 3ê°œì˜ ë‹¤ë¥¸ ë²„ì „ì„ ìƒì„±í•˜ì„¸ìš”:
1. ë™ì˜ì–´ë‚˜ ìœ ì‚¬ í‘œí˜„ì„ ì‚¬ìš©í•œ ë²„ì „
2. ë” êµ¬ì²´ì ì´ê±°ë‚˜ ìƒì„¸í•œ ë²„ì „  
3. ë” ì¼ë°˜ì ì´ê±°ë‚˜ ë„“ì€ ë²”ìœ„ì˜ ë²„ì „

ê·œì¹™:
- ê° ì§ˆë¬¸ì€ í•œ ì¤„ì— í•˜ë‚˜ì”© ì‘ì„±
- ë²ˆí˜¸ë‚˜ ê¸°í˜¸ ì—†ì´ ì§ˆë¬¸ë§Œ ì‘ì„±
- ì›ë³¸ ì§ˆë¬¸ì˜ ì˜ë„ë¥¼ ìœ ì§€
- LH, ì„ëŒ€ì£¼íƒ, ë¶„ì–‘ì£¼íƒ ê´€ë ¨ ìš©ì–´ í™œìš©

ì›ë³¸ ì§ˆë¬¸: {question}

ë³€í™˜ëœ ì§ˆë¬¸ë“¤:"""
```

### 2.4 ì½”ë“œ êµ¬í˜„

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

# ë‹¤ì¤‘ ì§ˆì˜ ìƒì„±ìš© LLM (temperature ë†’ê²Œ ì„¤ì •)
QUERY_LLM = ChatOpenAI(model="gpt-4o-mini", temperature=0.7, api_key=OPENAI_API_KEY)

def generate_multi_queries(question: str, num_queries: int = 3) -> List[str]:
    """ì›ë³¸ ì§ˆë¬¸ì„ ì—¬ëŸ¬ ê°œì˜ ë‹¤ë¥¸ í‘œí˜„ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤."""
    prompt = ChatPromptTemplate.from_template(MULTI_QUERY_PROMPT)
    
    # LangChain Expression Language (LCEL) ì²´ì¸ êµ¬ì„±
    chain = prompt | QUERY_LLM | StrOutputParser()
    
    # ì§ˆë¬¸ ë³€í™˜ ì‹¤í–‰
    result = chain.invoke({"question": question})
    
    # ê²°ê³¼ íŒŒì‹± (ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬)
    generated_queries = [q.strip() for q in result.strip().split("\n") if q.strip()]
    
    # ì›ë³¸ + ë³€í™˜ëœ ì§ˆë¬¸ë“¤ ë°˜í™˜
    all_queries = [question] + generated_queries[:num_queries]
    
    return all_queries
```

### 2.5 ìƒì„± ì˜ˆì‹œ

```
ì…ë ¥: "LH í–‰ë³µì£¼íƒ ì²­ë…„ ì¡°ê±´ì´ ë­ì•¼?"

ì¶œë ¥:
â”œâ”€â”€ [ì›ë³¸]  LH í–‰ë³µì£¼íƒ ì²­ë…„ ì¡°ê±´ì´ ë­ì•¼?
â”œâ”€â”€ [ë³€í™˜1] í–‰ë³µì£¼íƒ ì…ì£¼ ìê²© ìš”ê±´
â”œâ”€â”€ [ë³€í™˜2] ì²­ë…„ ëŒ€ìƒ LH ì„ëŒ€ì£¼íƒ ì‹ ì²­ ì¡°ê±´ ë° ìê²© ê¸°ì¤€
â””â”€â”€ [ë³€í™˜3] LH ê³µê³µì„ëŒ€ ì²­ë…„ ì£¼íƒ ì§€ì› ëŒ€ìƒ
```

### 2.6 Multi-Queryì˜ ì¥ì 

| ì¥ì  | ì„¤ëª… |
|------|------|
| **ê²€ìƒ‰ ë²”ìœ„ í™•ì¥** | ë‹¤ì–‘í•œ í‘œí˜„ìœ¼ë¡œ ë” ë§ì€ ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰ |
| **ë™ì˜ì–´ ì²˜ë¦¬** | "ì²­ë…„" â†” "ì Šì€ ì„¸ëŒ€", "ì¡°ê±´" â†” "ìê²© ìš”ê±´" |
| **ì§ˆë¬¸ ëª¨í˜¸ì„± í•´ì†Œ** | ë¶ˆëª…í™•í•œ ì§ˆë¬¸ì„ ì—¬ëŸ¬ ê´€ì ì—ì„œ í•´ì„ |
| **ëˆ„ë½ ë¬¸ì„œ ê°ì†Œ** | ë‹¨ì¼ í‘œí˜„ìœ¼ë¡œ ë†“ì¹  ìˆ˜ ìˆëŠ” ë¬¸ì„œ í¬ì°© |

---

## 3. Stage 1: Hybrid Retrieval (í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰)

### 3.1 ê°œë…

**Dense Retrieval**(ë°€ì§‘ ë²¡í„° ê²€ìƒ‰)ê³¼ **Sparse Retrieval**(í¬ì†Œ ë²¡í„° ê²€ìƒ‰)ì„ **ê²°í•©**í•˜ì—¬ ê° ë°©ì‹ì˜ ì¥ì ì„ ì·¨í•˜ëŠ” ê²€ìƒ‰ ë°©ë²•ì…ë‹ˆë‹¤.

### 3.2 Dense Retriever (PGVector)

#### ì‚¬ìš© ê¸°ìˆ 

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì„ë² ë”© ëª¨ë¸** | `text-embedding-3-small` (OpenAI) |
| **ë²¡í„° DB** | PostgreSQL + PGVector í™•ì¥ |
| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | `langchain_openai`, `langchain_postgres` |
| **í´ë˜ìŠ¤** | `OpenAIEmbeddings`, `PGVector`, `DistanceStrategy` |
| **ê±°ë¦¬ ì¸¡ì •** | Cosine Similarity |
| **ê²€ìƒ‰ ê°œìˆ˜** | top_k = 5 (ì§ˆì˜ë‹¹) |

#### ì½”ë“œ êµ¬í˜„

```python
from langchain_openai import OpenAIEmbeddings
from langchain_postgres import PGVector
from langchain_postgres.vectorstores import DistanceStrategy

# ì„ë² ë”© í•¨ìˆ˜ ì´ˆê¸°í™”
EMBEDDING_MODEL = "text-embedding-3-small"
embedding_function = OpenAIEmbeddings(
    model=EMBEDDING_MODEL, 
    openai_api_key=OPENAI_API_KEY
)

# DB ì—°ê²° ë¬¸ìì—´
CONNECTION_STRING = f"postgresql+psycopg2://{DB_CONFIG['user']}:{DB_CONFIG['password']}@{DB_CONFIG['host']}:{DB_CONFIG['port']}/{DB_CONFIG['database']}"

# PGVector ë²¡í„°ìŠ¤í† ì–´ ì´ˆê¸°í™”
VECTORSTORE = PGVector(
    connection=CONNECTION_STRING,
    embeddings=embedding_function,
    collection_name="document_chunks",
    distance_strategy=DistanceStrategy.COSINE,
)

# Retriever ìƒì„±
dense_retriever = VECTORSTORE.as_retriever(search_kwargs={"k": 10})
```

#### ì‘ë™ ì›ë¦¬

```
ì§ˆë¬¸: "í–‰ë³µì£¼íƒ ì²­ë…„ ì¡°ê±´"
         â”‚
         â–¼ (OpenAI Embedding API í˜¸ì¶œ)
    [0.023, -0.145, 0.089, ...]  (1536ì°¨ì› ë²¡í„°)
         â”‚
         â–¼ (PGVectorì—ì„œ Cosine Similarity ê³„ì‚°)
    DBì˜ ëª¨ë“  ë¬¸ì„œ ë²¡í„°ì™€ ë¹„êµ
         â”‚
         â–¼
    ìœ ì‚¬ë„ ë†’ì€ ìƒìœ„ ë¬¸ì„œ ë°˜í™˜
```

#### íŠ¹ì§•

| ì¥ì  | ë‹¨ì  |
|------|------|
| ì˜ë¯¸ì  ìœ ì‚¬ì„± íŒŒì•… ê°€ëŠ¥ | í¬ê·€ í‚¤ì›Œë“œ ë§¤ì¹­ì— ì•½í•¨ |
| "ì²­ë…„" â†” "ì Šì€ì´" ì—°ê²° | ì •í™•í•œ ê³ ìœ ëª…ì‚¬ ê²€ìƒ‰ ì–´ë ¤ì›€ |
| ë¬¸ë§¥ì„ ê³ ë ¤í•œ ê²€ìƒ‰ | ì„ë² ë”© API ë¹„ìš© ë°œìƒ |

### 3.3 Sparse Retriever (BM25)

#### ì‚¬ìš© ê¸°ìˆ 

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ì•Œê³ ë¦¬ì¦˜** | BM25Okapi (Best Matching 25) |
| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | `rank_bm25` |
| **DB ì—°ê²°** | `asyncpg` (ë¹„ë™ê¸°) |
| **ê²€ìƒ‰ ê°œìˆ˜** | top_k = 5 (ì§ˆì˜ë‹¹) |

#### ì½”ë“œ êµ¬í˜„

```python
from rank_bm25 import BM25Okapi
import asyncpg

async def load_sparse_retriever():
    """DBì—ì„œ ëª¨ë“  ì²­í¬ë¥¼ ë¡œë“œí•˜ì—¬ BM25 ê°ì²´ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."""
    conn = await asyncpg.connect(**DB_CONFIG)
    try:
        rows = await conn.fetch("""
            SELECT dc.chunk_text, a.title, a.category, a.region, a.notice_type, dc.metadata
            FROM document_chunks dc
            JOIN announcements a ON dc.announcement_id = a.id
        """)
        
        documents = []
        corpus = []
        for r in rows:
            # ë©”íƒ€ë°ì´í„° íŒŒì‹±
            metadata = json.loads(r["metadata"]) if isinstance(r["metadata"], str) else r["metadata"]
            metadata.update({
                "title": r["title"],
                "category": r["category"],
                "region": r["region"],
                "notice_type": r["notice_type"]
            })
            
            # Document ê°ì²´ ìƒì„±
            doc = Document(page_content=r["chunk_text"], metadata=metadata)
            documents.append(doc)
            
            # í† í°í™” (ë„ì–´ì“°ê¸° ê¸°ì¤€)
            corpus.append(r["chunk_text"].split())
        
        # BM25 ì¸ë±ìŠ¤ ìƒì„±
        bm25 = BM25Okapi(corpus)
        return bm25, documents
    finally:
        await conn.close()
```

#### BM25 ì•Œê³ ë¦¬ì¦˜ ì›ë¦¬

```
BM25 ì ìˆ˜ ê³µì‹:
score(D, Q) = Î£ IDF(qi) Ã— (tf(qi, D) Ã— (k1 + 1)) / (tf(qi, D) + k1 Ã— (1 - b + b Ã— |D|/avgdl))

- IDF(qi): ì—­ë¬¸ì„œ ë¹ˆë„ (í¬ê·€í•œ ë‹¨ì–´ì¼ìˆ˜ë¡ ë†’ì€ ì ìˆ˜)
- tf(qi, D): ë¬¸ì„œ Dì—ì„œ ë‹¨ì–´ qiì˜ ì¶œí˜„ ë¹ˆë„
- |D|: ë¬¸ì„œ ê¸¸ì´
- avgdl: í‰ê·  ë¬¸ì„œ ê¸¸ì´
- k1, b: íŠœë‹ íŒŒë¼ë¯¸í„° (ê¸°ë³¸ê°’: k1=1.5, b=0.75)
```

#### íŠ¹ì§•

| ì¥ì  | ë‹¨ì  |
|------|------|
| ì •í™•í•œ í‚¤ì›Œë“œ ë§¤ì¹­ì— ê°•í•¨ | ë™ì˜ì–´/ìœ ì‚¬ì–´ ì¸ì‹ ë¶ˆê°€ |
| í¬ê·€ í‚¤ì›Œë“œ ê²€ìƒ‰ì— íš¨ê³¼ì  | ë¬¸ë§¥ ì´í•´ ë¶ˆê°€ |
| ë¹ ë¥¸ ê²€ìƒ‰ ì†ë„ | |

### 3.4 Hybrid Search í†µí•©

```python
async def multi_query_search(question: str, bm25_data, top_k_per_query: int = 5) -> List[Document]:
    """ë‹¤ì¤‘ ì§ˆì˜ë¡œ Dense + Sparse ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."""
    
    # Multi-Query ìƒì„±
    queries = generate_multi_queries(question)
    bm25, sparse_docs = bm25_data
    all_docs = []
    
    for query in queries:
        # 1. Dense Search (PGVector)
        dense_results = dense_retriever.invoke(query)
        all_docs.extend(dense_results[:top_k_per_query])
        
        # 2. Sparse Search (BM25)
        tokenized_query = query.split()
        bm25_scores = bm25.get_scores(tokenized_query)
        sparse_with_scores = sorted(
            zip(sparse_docs, bm25_scores), 
            key=lambda x: x[1], 
            reverse=True
        )[:top_k_per_query]
        all_docs.extend([doc for doc, _ in sparse_with_scores])
    
    # ì¤‘ë³µ ì œê±°
    seen_texts = set()
    unique_docs = []
    for doc in all_docs:
        if doc.page_content not in seen_texts:
            unique_docs.append(doc)
            seen_texts.add(doc.page_content)
    
    return unique_docs, queries
```

### 3.5 Dense vs Sparse vs Hybrid ë¹„êµ

| êµ¬ë¶„ | Dense (ë²¡í„°) | Sparse (BM25) | Hybrid |
|------|-------------|---------------|--------|
| **ê²€ìƒ‰ ë°©ì‹** | ì˜ë¯¸ì  ìœ ì‚¬ë„ | í‚¤ì›Œë“œ ë§¤ì¹­ | ë‘˜ ë‹¤ |
| **ë™ì˜ì–´ ì²˜ë¦¬** | âœ… ê°€ëŠ¥ | âŒ ë¶ˆê°€ | âœ… ê°€ëŠ¥ |
| **í¬ê·€ í‚¤ì›Œë“œ** | âš ï¸ ì•½í•¨ | âœ… ê°•í•¨ | âœ… ê°•í•¨ |
| **ë¬¸ë§¥ ì´í•´** | âœ… ê°€ëŠ¥ | âŒ ë¶ˆê°€ | âœ… ê°€ëŠ¥ |
| **ì†ë„** | ì¤‘ê°„ | ë¹ ë¦„ | ëŠë¦¼ |
| **ì •í™•ë„** | ì¢‹ìŒ | ì¢‹ìŒ | **ìµœê³ ** |

---

## 4. Stage 2: Reranking (ì¬ì •ë ¬)

### 4.1 ê°œë…

1ë‹¨ê³„ì—ì„œ ê²€ìƒ‰ëœ í›„ë³´ ë¬¸ì„œë“¤ì„ **ë” ì •ë°€í•œ ëª¨ë¸(CrossEncoder)**ë¡œ ì¬í‰ê°€í•˜ì—¬ ìˆœìœ„ë¥¼ ì¬ì¡°ì •í•©ë‹ˆë‹¤.

### 4.2 ì‚¬ìš© ê¸°ìˆ 

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ëª¨ë¸** | `cross-encoder/ms-marco-MiniLM-L-6-v2` |
| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | `sentence-transformers` |
| **í´ë˜ìŠ¤** | `CrossEncoder` |
| **ëª¨ë¸ ìœ í˜•** | Cross-Encoder |

### 4.3 Bi-Encoder vs Cross-Encoder

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bi-Encoder (1ë‹¨ê³„ Dense Searchì—ì„œ ì‚¬ìš©)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì§ˆë¬¸ â”€â”€â†’ [ì¸ì½”ë”] â”€â”€â†’ ë²¡í„°A                                 â”‚
â”‚  ë¬¸ì„œ â”€â”€â†’ [ì¸ì½”ë”] â”€â”€â†’ ë²¡í„°B                                 â”‚
â”‚                                                             â”‚
â”‚  ìœ ì‚¬ë„ = cosine(ë²¡í„°A, ë²¡í„°B)                               â”‚
â”‚                                                             â”‚
â”‚  âœ… ì¥ì : ë¹ ë¦„ (ë¬¸ì„œ ë²¡í„° ë¯¸ë¦¬ ê³„ì‚° ê°€ëŠ¥)                     â”‚
â”‚  âŒ ë‹¨ì : ì§ˆë¬¸-ë¬¸ì„œ ìƒí˜¸ì‘ìš© ì œí•œì                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cross-Encoder (2ë‹¨ê³„ Rerankingì—ì„œ ì‚¬ìš©)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ì§ˆë¬¸ + ë¬¸ì„œ] â”€â”€â†’ [ì¸ì½”ë”] â”€â”€â†’ ê´€ë ¨ì„± ì ìˆ˜ (0~1)            â”‚
â”‚                                                             â”‚
â”‚  âœ… ì¥ì : ì§ˆë¬¸-ë¬¸ì„œ ê¹Šì€ ìƒí˜¸ì‘ìš©, ë” ì •í™•                   â”‚
â”‚  âŒ ë‹¨ì : ëŠë¦¼ (ë§¤ë²ˆ ê³„ì‚° í•„ìš”, ì‚¬ì „ ê³„ì‚° ë¶ˆê°€)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 ì½”ë“œ êµ¬í˜„

```python
from sentence_transformers import CrossEncoder

# CrossEncoder ëª¨ë¸ ë¡œë“œ
RERANKER_MODEL = "cross-encoder/ms-marco-MiniLM-L-6-v2"
RERANKER = CrossEncoder(RERANKER_MODEL)

def rerank_documents(question: str, docs: List[Document], top_k: int = 5) -> List[Document]:
    """CrossEncoderë¡œ ë¬¸ì„œ ì¬ì •ë ¬"""
    if not docs:
        return []
    
    # (ì§ˆë¬¸, ë¬¸ì„œ) ìŒ ìƒì„±
    pairs = [(question, doc.page_content) for doc in docs]
    
    # CrossEncoderë¡œ ì ìˆ˜ ê³„ì‚°
    scores = RERANKER.predict(pairs)
    
    # ì ìˆ˜ì™€ ë¬¸ì„œë¥¼ ë¬¶ì–´ ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
    reranked = [doc for _, doc in sorted(zip(scores, docs), key=lambda x: x[0], reverse=True)]
    
    return reranked[:top_k]
```

### 4.5 Reranking íš¨ê³¼ ì˜ˆì‹œ

```
ê²€ìƒ‰ ë‹¨ê³„ í›„ (ì•½ 20ê°œ í›„ë³´ ë¬¸ì„œ):
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ìˆœìœ„â”‚ ë¬¸ì„œ                        â”‚ ì´ˆê¸° ì ìˆ˜   â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ ì²­ë…„ í–‰ë³µì£¼íƒ ì¼ë°˜ ì•ˆë‚´      â”‚ 0.85       â”‚
â”‚ 2  â”‚ ì‹ í˜¼ë¶€ë¶€ íŠ¹ë³„ê³µê¸‰ ì•ˆë‚´       â”‚ 0.82       â”‚
â”‚ 3  â”‚ í–‰ë³µì£¼íƒ ì²­ë…„ ìê²© ì¡°ê±´ â˜…   â”‚ 0.80       â”‚ â† ì‹¤ì œë¡œ ê°€ì¥ ê´€ë ¨ ë†’ìŒ
â”‚ 4  â”‚ êµ­ë¯¼ì„ëŒ€ ì‹ ì²­ ë°©ë²•          â”‚ 0.78       â”‚
â”‚...â”‚ ...                         â”‚ ...        â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”‚
                    â–¼ CrossEncoder Reranking

Reranking í›„ (ìƒìœ„ 5ê°œ):
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ìˆœìœ„â”‚ ë¬¸ì„œ                        â”‚ ì¬ì •ë ¬ ì ìˆ˜ â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ í–‰ë³µì£¼íƒ ì²­ë…„ ìê²© ì¡°ê±´ â˜…   â”‚ 0.95       â”‚ â† 1ìœ„ë¡œ ìƒìŠ¹!
â”‚ 2  â”‚ ì²­ë…„ í–‰ë³µì£¼íƒ ì¼ë°˜ ì•ˆë‚´      â”‚ 0.88       â”‚
â”‚ 3  â”‚ ì²­ë…„ ì£¼ê±°ì§€ì› í”„ë¡œê·¸ë¨       â”‚ 0.75       â”‚
â”‚ 4  â”‚ ì‹ í˜¼ë¶€ë¶€ íŠ¹ë³„ê³µê¸‰ ì•ˆë‚´       â”‚ 0.62       â”‚
â”‚ 5  â”‚ êµ­ë¯¼ì„ëŒ€ ì‹ ì²­ ë°©ë²•          â”‚ 0.45       â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Stage 3: Prompt Engineering

### 5.1 ê°œë…

LLMì´ **ì •í™•í•˜ê³  ì¼ê´€ëœ ë‹µë³€**ì„ ìƒì„±í•˜ë„ë¡ ì²´ê³„ì ì¸ í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.

### 5.2 ì‚¬ìš© ê¸°ìˆ 

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | `langchain_core` |
| **í´ë˜ìŠ¤** | `ChatPromptTemplate`, `SystemMessage` |

### 5.3 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì¡°

```python
SYSTEM_PROMPT = """ë‹¹ì‹ ì€ LH(í•œêµ­í† ì§€ì£¼íƒê³µì‚¬)ì˜ ì„ëŒ€ì£¼íƒ ë° ë¶„ì–‘ì£¼íƒ ê³µê³  ì „ë¬¸ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.

## ì—­í• 
- ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ ì œê³µëœ ê²€ìƒ‰ ë¬¸ì„œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•˜ê³  ì¹œì ˆí•˜ê²Œ ë‹µë³€í•©ë‹ˆë‹¤.
- LH ê³µê³ ì˜ ìê²© ì¡°ê±´, ì‹ ì²­ ë°©ë²•, ì¼ì •, í•„ìš” ì„œë¥˜ ë“±ì— ëŒ€í•´ ì•ˆë‚´í•©ë‹ˆë‹¤.

## ë‹µë³€ ì›ì¹™
1. **ì •í™•ì„±**: ë°˜ë“œì‹œ ì œê³µëœ ë¬¸ì„œ ë‚´ìš©ë§Œì„ ê¸°ë°˜ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.
2. **ëª…í™•ì„±**: ë³µì¡í•œ ìê²© ì¡°ê±´ì´ë‚˜ ì ˆì°¨ëŠ” ë‹¨ê³„ë³„ë¡œ ë‚˜ëˆ„ì–´ ì„¤ëª…í•˜ì„¸ìš”.
3. **ì™„ì „ì„±**: ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì¤‘ìš” ì •ë³´ë¥¼ í¬í•¨í•˜ì„¸ìš”.
4. **ì¹œì ˆí•¨**: ì „ë¬¸ ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•˜ì„¸ìš”.

## ë‹µë³€ í˜•ì‹
- ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
- ì¤‘ìš”í•œ ë‚ ì§œ, ê¸ˆì•¡, ìê²© ì¡°ê±´ì€ **ê°•ì¡°** í‘œì‹œí•˜ì„¸ìš”.
- ì—¬ëŸ¬ í•­ëª©ì´ ìˆì„ ê²½ìš° ëª©ë¡ì´ë‚˜ í‘œë¡œ ì •ë¦¬í•˜ì„¸ìš”.

## ì£¼ì˜ì‚¬í•­
- ë¬¸ì„œì—ì„œ ë‹µì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°, ì†”ì§í•˜ê²Œ ì•ˆë‚´í•˜ì„¸ìš”.
- ê³µê³ ë§ˆë‹¤ ì¡°ê±´ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒì„ ì•ˆë‚´í•˜ì„¸ìš”.
"""
```

### 5.4 ë™ì  ì§ˆë¬¸ ë¶„ì„

ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¼ **ì¶”ê°€ ì§€ì‹œì‚¬í•­**ì„ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.

```python
def analyze_question_type(question: str) -> str:
    """ì§ˆë¬¸ ìœ í˜• ë¶„ì„ì— ë”°ë¥¸ LLM ì§€ì‹œì‚¬í•­ ì¶”ê°€"""
    additional_instructions = []
    
    # ìê²© ì¡°ê±´ ê´€ë ¨ ì§ˆë¬¸
    if any(kw in question for kw in ["ìê²©", "ì¡°ê±´", "ëŒ€ìƒ", "ëˆ„ê°€", "ì‹ ì²­í•  ìˆ˜ ìˆ"]):
        additional_instructions.append(
            "- ìê²© ì¡°ê±´ì„ êµ¬ì²´ì ìœ¼ë¡œ ë‚˜ì—´í•˜ê³ , ê° ì¡°ê±´ì˜ ì„¸ë¶€ ê¸°ì¤€(ì†Œë“, ë‚˜ì´, ê±°ì£¼ì§€ ë“±)ì„ ëª…ì‹œí•˜ì„¸ìš”."
        )
    
    # ì¼ì • ê´€ë ¨ ì§ˆë¬¸
    if any(kw in question for kw in ["ì¼ì •", "ê¸°ê°„", "ì–¸ì œ", "ë§ˆê°", "ì ‘ìˆ˜"]):
        additional_instructions.append(
            "- ëª¨ë“  ê´€ë ¨ ì¼ì •(ê³µê³ ì¼, ì ‘ìˆ˜ê¸°ê°„, ë‹¹ì²¨ì ë°œí‘œì¼, ê³„ì•½ì¼ ë“±)ì„ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”."
        )
    
    # ì‹ ì²­ ë°©ë²• ê´€ë ¨ ì§ˆë¬¸
    if any(kw in question for kw in ["ì‹ ì²­", "ë°©ë²•", "ì–´ë–»ê²Œ", "ì ˆì°¨", "ì„œë¥˜"]):
        additional_instructions.append(
            "- ì‹ ì²­ ì ˆì°¨ë¥¼ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•˜ê³ , í•„ìš”í•œ ì„œë¥˜ì™€ ì¤€ë¹„ë¬¼ì„ ëª©ë¡ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”."
        )
    
    # ë¹„ìš©/ê¸ˆì•¡ ê´€ë ¨ ì§ˆë¬¸
    if any(kw in question for kw in ["ë¹„ìš©", "ê¸ˆì•¡", "ë³´ì¦ê¸ˆ", "ì›”ì„¸", "ë¶„ì–‘ê°€", "ì–¼ë§ˆ"]):
        additional_instructions.append(
            "- ê¸ˆì•¡ ì •ë³´ëŠ” ì •í™•í•œ ìˆ«ìë¡œ ì œê³µí•˜ê³ , ê°€ëŠ¥í•˜ë©´ í‘œë¡œ ì •ë¦¬í•˜ì„¸ìš”."
        )
    
    # ë¹„êµ ì§ˆë¬¸
    if any(kw in question for kw in ["ì°¨ì´", "ë¹„êµ", "vs", "ì–´ë–¤ ê²ƒì´"]):
        additional_instructions.append(
            "- ë¹„êµ ëŒ€ìƒë“¤ì˜ ì°¨ì´ì ì„ í‘œë¡œ ì •ë¦¬í•˜ì—¬ í•œëˆˆì— ë³¼ ìˆ˜ ìˆê²Œ í•˜ì„¸ìš”."
        )
    
    if additional_instructions:
        return "\n\n## ì´ ì§ˆë¬¸ì— ëŒ€í•œ ì¶”ê°€ ì§€ì‹œì‚¬í•­\n" + "\n".join(additional_instructions)
    return ""
```

### 5.5 ì§ˆë¬¸ ìœ í˜•ë³„ ì¶”ê°€ ì§€ì‹œì‚¬í•­ ìš”ì•½

| ì§ˆë¬¸ ìœ í˜• | ê°ì§€ í‚¤ì›Œë“œ | ì¶”ê°€ ì§€ì‹œì‚¬í•­ |
|----------|------------|--------------|
| **ìê²© ì¡°ê±´** | ìê²©, ì¡°ê±´, ëŒ€ìƒ, ëˆ„ê°€ | ì†Œë“/ë‚˜ì´/ê±°ì£¼ì§€ ê¸°ì¤€ ëª…ì‹œ |
| **ì¼ì •** | ì–¸ì œ, ë§ˆê°, ì ‘ìˆ˜, ê¸°ê°„ | ì‹œê°„ìˆœ ì •ë¦¬ |
| **ì‹ ì²­ ë°©ë²•** | ì–´ë–»ê²Œ, ì ˆì°¨, ì„œë¥˜, ë°©ë²• | ë‹¨ê³„ë³„ ì„¤ëª… + ì„œë¥˜ ëª©ë¡ |
| **ë¹„ìš©** | ë³´ì¦ê¸ˆ, ì›”ì„¸, ë¶„ì–‘ê°€, ì–¼ë§ˆ | ê¸ˆì•¡ í‘œë¡œ ì •ë¦¬ |
| **ë¹„êµ** | ì°¨ì´, ë¹„êµ, vs | ë¹„êµí‘œ ì œê³µ |

### 5.6 ì»¨í…ìŠ¤íŠ¸ í¬ë§·íŒ…

ê²€ìƒ‰ëœ ë¬¸ì„œë¥¼ LLMì´ ì´í•´í•˜ê¸° ì‰¬ìš´ í˜•íƒœë¡œ êµ¬ì¡°í™”í•©ë‹ˆë‹¤.

```python
def format_context(docs: List[Document]) -> str:
    """LLM ì…ë ¥ì— ì‚¬ìš©í•  ë¬¸ì„œ í…ìŠ¤íŠ¸ë¥¼ í¬ë§·íŒ…"""
    context_parts = []
    for i, doc in enumerate(docs, 1):
        meta = doc.metadata
        header = f"[ë¬¸ì„œ {i}]"
        header += f" ê³µê³ ëª…: {meta.get('title', 'N/A')}"
        header += f" | ë¶„ë¥˜: {'ì„ëŒ€' if meta.get('category') == 'lease' else 'ë¶„ì–‘'}"
        header += f" | ì§€ì—­: {meta.get('region', 'N/A')}"
        
        context_parts.append(f"{header}\n{doc.page_content}")
    
    return "\n\n---\n\n".join(context_parts)
```

#### í¬ë§·íŒ… ê²°ê³¼ ì˜ˆì‹œ

```
[ë¬¸ì„œ 1] ê³µê³ ëª…: 2024ë…„ í–‰ë³µì£¼íƒ ì²­ë…„ ëª¨ì§‘ | ë¶„ë¥˜: ì„ëŒ€ | ì§€ì—­: ì„œìš¸
ì²­ë…„ ê³„ì¸µ ìê²© ì¡°ê±´:
- ë§Œ 19ì„¸ ì´ìƒ 39ì„¸ ì´í•˜
- ë¬´ì£¼íƒì
- ì†Œë“ ê¸°ì¤€: ë„ì‹œê·¼ë¡œì ì›”í‰ê·  ì†Œë“ 100% ì´í•˜
...

---

[ë¬¸ì„œ 2] ê³µê³ ëª…: í–‰ë³µì£¼íƒ ì…ì£¼ìê²© ì•ˆë‚´ | ë¶„ë¥˜: ì„ëŒ€ | ì§€ì—­: ì „êµ­
í–‰ë³µì£¼íƒì€ ì²­ë…„, ì‹ í˜¼ë¶€ë¶€, ê³ ë ¹ì ë“±ì„ ìœ„í•œ ê³µê³µì„ëŒ€ì£¼íƒì…ë‹ˆë‹¤.
...
```

---

## 6. Stage 4: Generation (ë‹µë³€ ìƒì„±)

### 6.1 ì‚¬ìš© ê¸°ìˆ 

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ëª¨ë¸** | GPT-4o-mini |
| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | `langchain_openai`, `langchain_core` |
| **í´ë˜ìŠ¤** | `ChatOpenAI`, `ChatPromptTemplate`, `SystemMessage` |
| **Temperature** | 0.2 (ì¼ê´€ëœ ë‹µë³€ì„ ìœ„í•´ ë‚®ê²Œ ì„¤ì •) |

### 6.2 ì½”ë“œ êµ¬í˜„

```python
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.messages import SystemMessage

# ë‹µë³€ ìƒì„±ìš© LLM
LLM = ChatOpenAI(model="gpt-4o-mini", temperature=0.2, api_key=OPENAI_API_KEY)

def create_rag_response(question: str, docs: List[Document], queries_used: List[str] = None) -> AnswerResponse:
    """RAG ë‹µë³€ ìƒì„±"""
    
    # ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
    if not docs:
        return AnswerResponse(
            answer="ì£„ì†¡í•©ë‹ˆë‹¤. ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ê³µê³  ë¬¸ì„œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n"
                   "ë‹¤ìŒì„ ì‹œë„í•´ ë³´ì„¸ìš”:\n"
                   "- ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”\n"
                   "- LH ì²­ì•½ì„¼í„°(https://apply.lh.or.kr)ì—ì„œ ì§ì ‘ ê²€ìƒ‰í•´ ë³´ì„¸ìš”\n"
                   "- LH ê³ ê°ì„¼í„°(1600-1004)ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”",
            source_documents=[],
            confidence="ë‚®ìŒ",
            queries_used=queries_used or []
        )
    
    # ì»¨í…ìŠ¤íŠ¸ ë° ì¶”ê°€ ì§€ì‹œì‚¬í•­ ìƒì„±
    context_text = format_context(docs)
    additional_instructions = analyze_question_type(question)
    final_system_prompt = SYSTEM_PROMPT + additional_instructions
    
    # ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    user_prompt = f"""## ê²€ìƒ‰ëœ ê³µê³  ë¬¸ì„œ

{context_text}

---

## ì‚¬ìš©ì ì§ˆë¬¸
{question}

ìœ„ ë¬¸ì„œë“¤ì„ ì°¸ê³ í•˜ì—¬ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ ì£¼ì„¸ìš”."""

    # í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ìƒì„±
    prompt_template = ChatPromptTemplate.from_messages([
        SystemMessage(content=final_system_prompt),
        ("user", user_prompt)
    ])
    
    # LLM í˜¸ì¶œ
    messages = prompt_template.format_messages()
    llm_output = LLM.invoke(messages)
    
    # ì‹ ë¢°ë„ ê³„ì‚°
    confidence = "ë†’ìŒ" if len(docs) >= 3 else "ì¤‘ê°„" if len(docs) >= 1 else "ë‚®ìŒ"
    
    # ì‘ë‹µ ìƒì„±
    response = AnswerResponse(
        answer=llm_output.content,
        source_documents=format_source_info(docs),
        confidence=confidence,
        queries_used=queries_used or []
    )
    return response
```

### 6.3 í”„ë¡¬í”„íŠ¸ êµ¬ì„± íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ìµœì¢… í”„ë¡¬í”„íŠ¸ êµ¬ì„±                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [System Message]                                               â”‚
â”‚  â”œâ”€â”€ ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì—­í• , ì›ì¹™, í˜•ì‹, ì£¼ì˜ì‚¬í•­)              â”‚
â”‚  â””â”€â”€ + ë™ì  ì¶”ê°€ ì§€ì‹œì‚¬í•­ (ì§ˆë¬¸ ìœ í˜•ì— ë”°ë¼)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [User Message]                                                 â”‚
â”‚  â”œâ”€â”€ ê²€ìƒ‰ëœ ë¬¸ì„œ (ë©”íƒ€ë°ì´í„° + ë³¸ë¬¸)                              â”‚
â”‚  â””â”€â”€ ì‚¬ìš©ì ì§ˆë¬¸                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    GPT-4o-mini ë‹µë³€ ìƒì„±
```

---

## 7. Stage 5: Response Formatting

### 7.1 ê°œë…

LLMì˜ ì¶œë ¥ì„ **êµ¬ì¡°í™”ëœ í˜•íƒœ**ë¡œ ì •ë¦¬í•˜ì—¬ ì¼ê´€ëœ ì‘ë‹µ í˜•ì‹ì„ ì œê³µí•©ë‹ˆë‹¤.

### 7.2 ì‚¬ìš© ê¸°ìˆ 

| í•­ëª© | ë‚´ìš© |
|------|------|
| **ë¼ì´ë¸ŒëŸ¬ë¦¬** | `pydantic` |
| **í´ë˜ìŠ¤** | `BaseModel`, `Field` |
| **ëª©ì ** | ì‘ë‹µ ë°ì´í„° ê²€ì¦ ë° êµ¬ì¡°í™” |

### 7.3 Pydantic ëª¨ë¸ ì •ì˜

```python
from pydantic import BaseModel, Field
from typing import List, Dict

class AnswerResponse(BaseModel):
    answer: str = Field(
        description="ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ (ë§ˆí¬ë‹¤ìš´)"
    )
    source_documents: List[Dict[str, str]] = Field(
        description="ì°¸ê³  ë¬¸ì„œ ì •ë³´"
    )
    confidence: str = Field(
        default="ë†’ìŒ", 
        description="ë‹µë³€ ì‹ ë¢°ë„: ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ"
    )
    queries_used: List[str] = Field(
        default=[], 
        description="ê²€ìƒ‰ì— ì‚¬ìš©ëœ ì§ˆì˜ ëª©ë¡"
    )
```

### 7.4 ì‹ ë¢°ë„ íŒë‹¨ ê¸°ì¤€

| ë¬¸ì„œ ìˆ˜ | ì‹ ë¢°ë„ | ì˜ë¯¸ |
|--------|--------|------|
| 3ê°œ ì´ìƒ | ë†’ìŒ | ì¶©ë¶„í•œ ê·¼ê±°ë¡œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë‹µë³€ |
| 1~2ê°œ | ì¤‘ê°„ | ì¼ë¶€ ê·¼ê±° ì¡´ì¬, ì¶”ê°€ í™•ì¸ ê¶Œì¥ |
| 0ê°œ | ë‚®ìŒ | ê·¼ê±° ë¶€ì¡±, ë‹µë³€ ë¶ˆê°€ |

### 7.5 ì¶œì²˜ ì •ë³´ í¬ë§·íŒ…

```python
def format_source_info(docs: List[Document]) -> List[Dict[str, str]]:
    """ë‹µë³€ ì¶œë ¥ ì‹œ ì°¸ê³ í•  ë¬¸ì„œ ì •ë³´ë¥¼ í¬ë§·íŒ…"""
    info = []
    seen = set()
    for doc in docs:
        title = doc.metadata.get("title", "N/A")
        if title not in seen:  # ì¤‘ë³µ ì œê±°
            seen.add(title)
            info.append({
                "ê³µê³ ëª…": title,
                "ë¶„ë¥˜": "ì„ëŒ€" if doc.metadata.get("category") == "lease" else "ë¶„ì–‘",
                "ì§€ì—­": doc.metadata.get("region", "N/A"),
                "ê³µê³ ìœ í˜•": doc.metadata.get("notice_type", "N/A"),
            })
    return info
```

### 7.6 ìµœì¢… ì‘ë‹µ ì¶œë ¥ ì˜ˆì‹œ

```
====================================================================================================
### ğŸ’¬ ë‹µë³€ ###
====================================================================================================

**Q1. LH í–‰ë³µì£¼íƒ ì²­ë…„ ëŒ€ìƒ ì¡°ê±´ì€ ë¬´ì—‡ì¸ê°€ìš”?**

í–‰ë³µì£¼íƒ ì²­ë…„ ê³„ì¸µì˜ ìê²© ì¡°ê±´ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

## ê¸°ë³¸ ìê²© ì¡°ê±´
- **ì—°ë ¹**: ë§Œ 19ì„¸ ì´ìƒ 39ì„¸ ì´í•˜
- **ì£¼íƒ ì†Œìœ **: ë¬´ì£¼íƒì
- **ì†Œë“ ê¸°ì¤€**: ë„ì‹œê·¼ë¡œì ì›”í‰ê·  ì†Œë“ 100% ì´í•˜

## ìš°ì„ ê³µê¸‰ ëŒ€ìƒ
1. ëŒ€í•™ìƒ: ëŒ€í•™ ì¬í•™ ì¤‘ì´ê±°ë‚˜ ì…í•™/ë³µí•™ ì˜ˆì •ì
2. ì·¨ì—…ì¤€ë¹„ìƒ: ëŒ€í•™ ì¡¸ì—… í›„ 2ë…„ ì´ë‚´
3. ì‚¬íšŒì´ˆë…„ìƒ: ì†Œë“ì´ ìˆëŠ” ì—…ë¬´ ì¢…ì‚¬ì

ğŸ“ ìì„¸í•œ ì‚¬í•­ì€ LH ê³ ê°ì„¼í„°(1600-1004)ë¡œ ë¬¸ì˜í•˜ì„¸ìš”.

----------------------------------------------------------------------------------------------------
### ğŸ“š ì°¸ê³  ë¬¸ì„œ (3ê±´) | ì‹ ë¢°ë„: ë†’ìŒ ###
----------------------------------------------------------------------------------------------------

| ìˆœë²ˆ | ê³µê³ ëª… | ë¶„ë¥˜ | ì§€ì—­ | ê³µê³ ìœ í˜• |
| :---: | :--- | :---: | :---: | :---: |
| 1 | 2024ë…„ í–‰ë³µì£¼íƒ ì²­ë…„ ëª¨ì§‘ê³µê³  | ì„ëŒ€ | ì„œìš¸ | ì…ì£¼ìëª¨ì§‘ |
| 2 | í–‰ë³µì£¼íƒ ì…ì£¼ìê²© ì•ˆë‚´ | ì„ëŒ€ | ì „êµ­ | ì¼ë°˜ |
| 3 | ì²­ë…„ ì£¼ê±°ì§€ì› í”„ë¡œê·¸ë¨ ì•ˆë‚´ | ì„ëŒ€ | ì „êµ­ | ì¼ë°˜ |

----------------------------------------------------------------------------------------------------
### ğŸ”„ ê²€ìƒ‰ì— ì‚¬ìš©ëœ ì§ˆì˜ ###
----------------------------------------------------------------------------------------------------
  [ì›ë³¸] LH í–‰ë³µì£¼íƒ ì²­ë…„ ëŒ€ìƒ ì¡°ê±´ì€ ë¬´ì—‡ì¸ê°€ìš”?
  [ë³€í™˜1] í–‰ë³µì£¼íƒ ì…ì£¼ ìê²© ìš”ê±´
  [ë³€í™˜2] ì²­ë…„ ëŒ€ìƒ LH ì„ëŒ€ì£¼íƒ ì‹ ì²­ ì¡°ê±´ ë° ìê²© ê¸°ì¤€
  [ë³€í™˜3] LH ê³µê³µì„ëŒ€ ì²­ë…„ ì£¼íƒ ì§€ì› ëŒ€ìƒ

----------------------------------------------------------------------------------------------------
### â±ï¸ ì²˜ë¦¬ ì‹œê°„ ###
----------------------------------------------------------------------------------------------------
  â€¢ ë¬¸ì„œ ê²€ìƒ‰: 2.35ì´ˆ
  â€¢ ë‹µë³€ ìƒì„±: 1.82ì´ˆ
  â€¢ ì´ ì†Œìš” ì‹œê°„: 4.17ì´ˆ
```

---

## 8. ê¸°ìˆ  ìŠ¤íƒ ìš”ì•½

### 8.1 ì „ì²´ ê¸°ìˆ  ìŠ¤íƒ

| ì¹´í…Œê³ ë¦¬ | ê¸°ìˆ /ë¼ì´ë¸ŒëŸ¬ë¦¬ | í´ë˜ìŠ¤/í•¨ìˆ˜ | ìš©ë„ |
|----------|----------------|-------------|------|
| **LLM** | `langchain_openai` | `ChatOpenAI` | ë‹µë³€ ìƒì„±, Multi-Query ìƒì„± |
| **ì„ë² ë”©** | `langchain_openai` | `OpenAIEmbeddings` | í…ìŠ¤íŠ¸ â†’ ë²¡í„° ë³€í™˜ |
| **ë²¡í„° DB** | `langchain_postgres` | `PGVector`, `DistanceStrategy` | ì„ë² ë”© ì €ì¥ ë° ìœ ì‚¬ë„ ê²€ìƒ‰ |
| **í‚¤ì›Œë“œ ê²€ìƒ‰** | `rank_bm25` | `BM25Okapi` | í¬ì†Œ ë²¡í„° ê²€ìƒ‰ |
| **ì¬ì •ë ¬** | `sentence-transformers` | `CrossEncoder` | ê²€ìƒ‰ ê²°ê³¼ ì •ë°€ ì¬ì •ë ¬ |
| **í”„ë¡¬í”„íŠ¸** | `langchain_core` | `ChatPromptTemplate`, `SystemMessage` | í”„ë¡¬í”„íŠ¸ êµ¬ì„± |
| **ì¶œë ¥ íŒŒì‹±** | `langchain_core` | `StrOutputParser` | LLM ì¶œë ¥ íŒŒì‹± |
| **ë°ì´í„° ê²€ì¦** | `pydantic` | `BaseModel`, `Field` | ì‘ë‹µ êµ¬ì¡°í™” |
| **DB ì—°ê²°** | `asyncpg` | `connect`, `fetch` | PostgreSQL ë¹„ë™ê¸° ì—°ê²° |
| **í™˜ê²½ ë³€ìˆ˜** | `python-dotenv` | `load_dotenv` | API í‚¤ ê´€ë¦¬ |

### 8.2 íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
# LangChain ê´€ë ¨
pip install langchain-core langchain-openai langchain-postgres

# ê²€ìƒ‰ ë° ì¬ì •ë ¬
pip install rank-bm25 sentence-transformers

# ë°ì´í„°ë² ì´ìŠ¤
pip install asyncpg psycopg2-binary pgvector

# ìœ í‹¸ë¦¬í‹°
pip install pydantic python-dotenv
```

### 8.3 í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (.env)

```env
OPENAI_API_KEY=sk-your-openai-api-key
```

---

## 9. ì½”ë“œ êµ¬ì¡°

### 9.1 íŒŒì¼ êµ¬ì¡°

```
project/
â”œâ”€â”€ .env                          # í™˜ê²½ ë³€ìˆ˜ (API í‚¤)
â”œâ”€â”€ requirements.txt              # íŒ¨í‚¤ì§€ ëª©ë¡
â”œâ”€â”€ rag_pipeline.py           # ë©”ì¸ ì½”ë“œ (.py ìŠ¤í¬ë¦½íŠ¸ìš©)
â”œâ”€â”€ rag_pipeline.ipynb        # Jupyter Notebook ë²„ì „
â””â”€â”€ rag_architecture.md       # ì•„í‚¤í…ì²˜ ë¬¸ì„œ
```

### 9.2 í•¨ìˆ˜ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ì´ˆê¸°í™” í•¨ìˆ˜                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ load_sparse_retriever()     - BM25 ë°ì´í„° ë¡œë“œ (async)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ê²€ìƒ‰ ê´€ë ¨ í•¨ìˆ˜                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ generate_multi_queries()    - Multi-Query ìƒì„±                â”‚
â”‚ â€¢ multi_query_search()        - Hybrid Search (async)           â”‚
â”‚ â€¢ rerank_documents()          - CrossEncoder Rerank             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ì‘ë‹µ ìƒì„± í•¨ìˆ˜                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ format_context()            - ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ í¬ë§·íŒ…             â”‚
â”‚ â€¢ format_source_info()        - ì¶œì²˜ ì •ë³´ í¬ë§·íŒ…                â”‚
â”‚ â€¢ analyze_question_type()     - ì§ˆë¬¸ ìœ í˜• ë¶„ì„                  â”‚
â”‚ â€¢ create_rag_response()       - RAG ë‹µë³€ ìƒì„±                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ì‹¤í–‰ í•¨ìˆ˜                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ run_question_rag()          - í†µí•© ì‹¤í–‰ í•¨ìˆ˜ (async)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. ë°ì´í„° íë¦„

### 10.1 ì „ì²´ ë°ì´í„° íë¦„

```
ì‚¬ìš©ì ì§ˆë¬¸: "LH í–‰ë³µì£¼íƒ ì²­ë…„ ì¡°ê±´ì´ ë­ì•¼?"
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 0: Multi-Query ìƒì„±                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Input:  ì›ë³¸ ì§ˆë¬¸ 1ê°œ                                        â”‚
â”‚ Output: ì›ë³¸ + ë³€í™˜ ì§ˆë¬¸ 4ê°œ                                  â”‚
â”‚ ëª¨ë¸:   GPT-4o-mini (temperature=0.7)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: Hybrid Retrieval                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Input:  ì§ˆë¬¸ 4ê°œ                                             â”‚
â”‚ Process:                                                     â”‚
â”‚   - Dense Search (PGVector): ì§ˆì˜ë‹¹ 5ê°œ Ã— 4 = 20ê°œ           â”‚
â”‚   - Sparse Search (BM25): ì§ˆì˜ë‹¹ 5ê°œ Ã— 4 = 20ê°œ              â”‚
â”‚   - í•©ê³„: ìµœëŒ€ 40ê°œ â†’ ì¤‘ë³µ ì œê±° â†’ ì•½ 15~25ê°œ                  â”‚
â”‚ Output: í›„ë³´ ë¬¸ì„œ 15~25ê°œ                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2: Reranking                                           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Input:  í›„ë³´ ë¬¸ì„œ 15~25ê°œ                                    â”‚
â”‚ Process: CrossEncoderë¡œ (ì§ˆë¬¸, ë¬¸ì„œ) ìŒ ì ìˆ˜ ê³„ì‚°             â”‚
â”‚ Output: ìƒìœ„ 5ê°œ ë¬¸ì„œ                                        â”‚
â”‚ ëª¨ë¸:   ms-marco-MiniLM-L-6-v2                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 3: Prompt Engineering                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Input:  ìƒìœ„ 5ê°œ ë¬¸ì„œ + ì›ë³¸ ì§ˆë¬¸                             â”‚
â”‚ Process:                                                     â”‚
â”‚   - ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±                                      â”‚
â”‚   - ì§ˆë¬¸ ìœ í˜• ë¶„ì„ â†’ ë™ì  ì§€ì‹œì‚¬í•­ ì¶”ê°€                        â”‚
â”‚   - ë¬¸ì„œ ì»¨í…ìŠ¤íŠ¸ í¬ë§·íŒ… (ë©”íƒ€ë°ì´í„° í¬í•¨)                     â”‚
â”‚ Output: ìµœì¢… í”„ë¡¬í”„íŠ¸ (System + User ë©”ì‹œì§€)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 4: Generation                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Input:  ìµœì¢… í”„ë¡¬í”„íŠ¸                                        â”‚
â”‚ Process: LLM í˜¸ì¶œ                                            â”‚
â”‚ Output: ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ë‹µë³€                                    â”‚
â”‚ ëª¨ë¸:   GPT-4o-mini (temperature=0.2)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 5: Response Formatting                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Input:  LLM ë‹µë³€ + ë¬¸ì„œ ë©”íƒ€ë°ì´í„° + ì‚¬ìš©ëœ ì§ˆì˜              â”‚
â”‚ Process:                                                     â”‚
â”‚   - Pydantic ëª¨ë¸ë¡œ êµ¬ì¡°í™”                                    â”‚
â”‚   - ì‹ ë¢°ë„ ê³„ì‚° (ë¬¸ì„œ ìˆ˜ ê¸°ë°˜)                                â”‚
â”‚   - ì¶œì²˜ ì •ë³´ ì •ë¦¬ (ì¤‘ë³µ ì œê±°)                                â”‚
â”‚ Output: AnswerResponse ê°ì²´                                  â”‚
â”‚   - answer: ë§ˆí¬ë‹¤ìš´ ë‹µë³€                                     â”‚
â”‚   - source_documents: ì°¸ê³  ë¬¸ì„œ ëª©ë¡                          â”‚
â”‚   - confidence: ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ                                â”‚
â”‚   - queries_used: ì‚¬ìš©ëœ ì§ˆì˜ ëª©ë¡                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 ë‹¨ê³„ë³„ ì˜ˆìƒ ì²˜ë¦¬ ì‹œê°„

| ë‹¨ê³„ | ì˜ˆìƒ ì‹œê°„ | ë¹„ê³  |
|------|----------|------|
| Stage 0: Multi-Query | ~1.0ì´ˆ | LLM API í˜¸ì¶œ |
| Stage 1: Hybrid Search | ~2.0ì´ˆ | DB ê²€ìƒ‰ + BM25 ê³„ì‚° |
| Stage 2: Reranking | ~0.5ì´ˆ | CrossEncoder ì¶”ë¡  |
| Stage 3: Prompt Engineering | ~0.01ì´ˆ | ë¬¸ìì—´ ì²˜ë¦¬ |
| Stage 4: Generation | ~1.5ì´ˆ | LLM API í˜¸ì¶œ |
| Stage 5: Formatting | ~0.01ì´ˆ | ë°ì´í„° êµ¬ì¡°í™” |
| **ì´í•©** | **~5ì´ˆ** | |

### 10.3 ë‹¨ì¼ ì§ˆì˜ vs Multi-Query ë¹„êµ

| í•­ëª© | ë‹¨ì¼ ì§ˆì˜ | Multi-Query |
|------|----------|-------------|
| ê²€ìƒ‰ ì§ˆì˜ ìˆ˜ | 1ê°œ | 4ê°œ (ì›ë³¸ + 3ê°œ ë³€í™˜) |
| í›„ë³´ ë¬¸ì„œ ìˆ˜ | 5~10ê°œ | 30~40ê°œ â†’ ì¤‘ë³µ ì œê±° í›„ 15~25ê°œ |
| ê²€ìƒ‰ ë²”ìœ„ | ì¢ìŒ | **ë„“ìŒ** |
| API í˜¸ì¶œ | ê²€ìƒ‰ë§Œ | ì§ˆë¬¸ ë³€í™˜ LLM + ê²€ìƒ‰ |
| ì²˜ë¦¬ ì‹œê°„ | ~3ì´ˆ | ~5ì´ˆ |
| ì •í™•ë„ | ê¸°ë³¸ | **í–¥ìƒ** |

---

## 11. í™•ì¥ ê°€ëŠ¥ì„±

### 11.1 ì¶”ê°€ ê°€ëŠ¥í•œ ê¸°ëŠ¥

| ê¸°ëŠ¥ | ì„¤ëª… | ë‚œì´ë„ |
|------|------|--------|
| **Query Decomposition** | ë³µì¡í•œ ì§ˆë¬¸ì„ í•˜ìœ„ ì§ˆë¬¸ìœ¼ë¡œ ë¶„í•´ | ì¤‘ |
| **Self-RAG** | ê²€ìƒ‰ í•„ìš”ì„± íŒë‹¨ + ë‹µë³€ í’ˆì§ˆ ìì²´ í‰ê°€ | ìƒ |
| **HyDE** | ê°€ìƒ ë¬¸ì„œ ìƒì„± í›„ ê²€ìƒ‰ | ì¤‘ |
| **Contextual Compression** | ê´€ë ¨ ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ì—¬ ì»¨í…ìŠ¤íŠ¸ ì••ì¶• | ì¤‘ |
| **Chat History** | ëŒ€í™” ì´ë ¥ ê¸°ë°˜ ë§¥ë½ ìœ ì§€ | ì¤‘ |
| **Feedback Loop** | ì‚¬ìš©ì í”¼ë“œë°±ìœ¼ë¡œ ê²€ìƒ‰ ê°œì„  | ìƒ |
| **Streaming** | ë‹µë³€ ìŠ¤íŠ¸ë¦¬ë° ì¶œë ¥ | í•˜ |

### 11.2 ì„±ëŠ¥ ìµœì í™” ë°©ì•ˆ

| ë°©ì•ˆ | ì„¤ëª… |
|------|------|
| **BM25 ì‚¬ì „ ë¡œë”©** | ì„œë²„ ì‹œì‘ ì‹œ BM25 ì¸ë±ìŠ¤ ë¯¸ë¦¬ ë¡œë“œ (í˜„ì¬ êµ¬í˜„ë¨) |
| **ìºì‹±** | ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ì— ëŒ€í•œ ì‘ë‹µ ìºì‹± |
| **ë°°ì¹˜ ì„ë² ë”©** | ì—¬ëŸ¬ ì§ˆì˜ ì„ë² ë”©ì„ í•œ ë²ˆì— ì²˜ë¦¬ |
| **ë¹„ë™ê¸° ë³‘ë ¬ ì²˜ë¦¬** | Dense/Sparse ê²€ìƒ‰ ë™ì‹œ ì‹¤í–‰ |

---